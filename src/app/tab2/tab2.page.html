<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      {{ 'ASISTANT_TAB_MAIN.HEADER_TITLE' | translate }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="min-h-full bg-gray-100 dark:bg-gray-950 dark:text-white flex flex-col ">
    <div *ngIf="messages.length == 0" class="text-center text-base p-4">
      <h2 class="text-gray-400 text-[19px]">{{'ASISTANT_TAB_MAIN.QUESTION_TITLE' | translate }}</h2>
      <div class="grid grid-cols-1 justify-center items-center w-full gap-1">
        <app-suggestion-card *ngFor="let pregunta of preguntasParaIaPorDefecto" [text]="pregunta"
          hoverBgColor="hover:bg-[#e5dbff]" hoverTextColor="hover:text-[#660066]" textSize="text-[15px]"
          (cardClick)="onSuggestionClick($event)"></app-suggestion-card>
      </div>
    </div>
    <div>
      <app-chat [messages]="messages"></app-chat>
    </div>
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 p-4 dark:border-t dark:border-gray-700">
      <form (ngSubmit)="onSubmit()" class="flex items-center gap-2">
        <input type="text" placeholder="{{ 'ASISTANT_TAB_MAIN.A_IA_CHAT_INPUT_PLACEHOLDER' | translate }}" class="
    flex-1
    px-4 py-3 text-base
    border-b-2 border-white
    dark:border-gray-700
    focus:outline-none
    focus:border-[#660066]
    transition-all duration-500 ease-in-out
    dark:bg-gray-950
    dark:text-white
  " [(ngModel)]="userInput" name="userInput" [disabled]="isLoading" />

        <!-- Botón de enviar -->
        <button type="submit" [disabled]="isLoading"
          class=" transition-all duration-200 flex items-center justify-center  dark:text-white
    disabled:bg-gray-300 dark:disabled:bg-gray-700 dark:border-white disabled:cursor-not-allowed">
          <!-- Icono de enviar (triángulo/flecha) -->
          <ion-icon name="send-sharp" size="large" class="text-[#660066]"></ion-icon>
        </button>
        <button type="button" (click)="toggleListening()" [disabled]="!isSpeechAvailable" [class]="isListening 
          ? 'bg-red-600 hover:bg-red-700 text-white rounded-lg' 
          : 'bg-white-600 text-[#660066]'"
          class="disabled:bg-gray-300 dark:disabled:bg-gray-700  w-12 h-12 rounded-full flex items-center justify-center transition-colors">
          <ion-icon [name]="isListening ? 'stop-circle' : 'mic'" size="large"></ion-icon>
        </button>
      </form>
    </div>
  </div>

  <!-- MODAL: escuchando (ANILLO) -->
  <div *ngIf="isListening" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-8 text-center shadow-2xl w-[320px]">

      <!-- Anillo + mic -->
      <div class="relative w-32 h-32 mx-auto mb-6">
        <!-- ping suave -->
        <div class="absolute inset-0 bg-[#660066] rounded-full animate-ping opacity-20"></div>

        <!-- Anillo -->
        <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 120 120">
          <!-- Fondo -->
          <circle
            cx="60" cy="60" r="52"
            fill="none"
            stroke="rgba(0,0,0,0.10)"
            stroke-width="10"
          ></circle>

          <!-- Progreso -->
          <circle
            cx="60" cy="60" r="52"
            fill="none"
            stroke="#660066"
            stroke-width="10"
            stroke-linecap="round"
            [attr.stroke-dasharray]="ringCircumference"
            [attr.stroke-dashoffset]="ringDashOffset"
            style="transition: stroke-dashoffset 100ms linear;"
          ></circle>
        </svg>

        <!-- Centro -->
        <div class="absolute inset-3 bg-[#660066] rounded-full flex items-center justify-center shadow-xl">
          <ion-icon name="mic" class="text-white text-6xl"></ion-icon>
        </div>

        <!-- Segundos -->
        <div class="absolute -bottom-7 left-0 right-0 text-center">
          <span class="text-sm font-semibold text-gray-700">
            {{ (silenceRemainingMs / 1000) | number:'1.0-1' }}s
          </span>
        </div>
      </div>

      <h3 class="text-xl font-bold mb-2">
        {{ 'ASISTANT_TAB_MAIN.LISTENING' | translate }}
      </h3>

      <p class="text-gray-600 mb-2">
        {{ 'ASISTANT_TAB_MAIN.TALK_NOW' | translate }}
      </p>

      <p class="text-xs text-gray-500 mb-4">
        Si vuelves a hablar, el contador se reinicia.
      </p>

      <button
        (click)="toggleListening()"
        class="w-full h-12 bg-[#660066] text-white rounded-full px-6 py-3 transition-colors hover:bg-[#7a007a]"
        style="border-radius: 10px;"
      >
        {{ 'ASISTANT_TAB_MAIN.STOP_LISTENING' | translate }}
      </button>
    </div>
  </div>

  <!-- Aviso si no hay STT -->
  <div *ngIf="!isSpeechAvailable" class="p-2">
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg mb-4">
      <p>⚠️ Reconocimiento de voz no disponible en este navegador</p>
    </div>
  </div>

</ion-content>